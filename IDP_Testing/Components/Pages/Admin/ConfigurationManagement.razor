@page "/admin/configuration"
@using IDP_Testing.Services
@using IDP_Testing.Models
@attribute [Authorize(Roles = "app-admin")]
@rendermode InteractiveServer
@inject IConfigurationService ConfigService
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime

<PageTitle>Configuration Management</PageTitle>

<div class="container mt-4">
    <h3><i class="bi bi-gear-fill"></i> Configuration Management</h3>
    <p class="text-muted">View active configuration and manage database overrides</p>

    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "active" ? "active" : "")" 
                    @onclick="ShowActiveTab" 
                    type="button">
                <i class="bi bi-eye"></i> Active Configuration
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "database" ? "active" : "")" 
                    @onclick="ShowDatabaseTab" 
                    type="button">
                <i class="bi bi-database"></i> Database Overrides
            </button>
        </li>
    </ul>

    @if (activeTab == "active")
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            This shows the <strong>currently active configuration</strong> loaded in the application. 
            Database values override appsettings.json values.
        </div>

        <div class="mb-3 row">
            <div class="col-md-8">
                <input type="text" 
                       class="form-control" 
                       placeholder="Search configuration keys..." 
                       @bind="searchFilter"
                       @bind:event="oninput"
                       @bind:after="ResetActivePage" />
            </div>
            <div class="col-md-4">
                <select class="form-select" @bind="activePageSize" @bind:after="ResetActivePage">
                    <option value="10">10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Active Value</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var config in GetPagedActiveConfigurations())
                    {
                        <tr>
                            <td>
                                <code>@config.Key</code>
                                @if (config.IsInDatabase)
                                {
                                    <span class="badge bg-warning text-dark ms-2">
                                        <i class="bi bi-database"></i> DB Override
                                    </span>
                                }
                            </td>
                            <td>
                                @if (IsSensitiveKey(config.Key))
                                {
                                    <span class="text-muted">
                                        <i class="bi bi-lock-fill"></i> ••••••••
                                    </span>
                                }
                                else
                                {
                                    @config.Value
                                }
                            </td>
                            <td>
                                @if (config.IsInDatabase)
                                {
                                    <span class="badge bg-primary">Database</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">AppSettings</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!GetFilteredActiveConfigurations().Any())
        {
            <div class="alert alert-warning">
                No configuration values match your search.
            </div>
        }
        else
        {
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <p class="text-muted mb-0">
                        <i class="bi bi-info-circle"></i> 
                        Showing @GetPagedActiveConfigurations().Count() of @GetFilteredActiveConfigurations().Count 
                        (@activeConfigurations.Count total)
                    </p>
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(activeCurrentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="ActivePreviousPage" disabled="@(activeCurrentPage == 1)">
                                <i class="bi bi-chevron-left"></i> Previous
                            </button>
                        </li>
                        @for (int i = GetActiveStartPage(); i <= GetActiveEndPage(); i++)
                        {
                            var pageNum = i;  // ← Renamed to "pageNum" to avoid conflict
                            <li class="page-item @(activeCurrentPage == pageNum ? "active" : "")">
                                <button class="page-link" @onclick="() => GoToActivePage(pageNum)">@pageNum</button>
                            </li>
                        }
                        <li class="page-item @(activeCurrentPage == GetActiveTotalPages() ? "disabled" : "")">
                            <button class="page-link" @onclick="ActiveNextPage" disabled="@(activeCurrentPage == GetActiveTotalPages())">
                                Next <i class="bi bi-chevron-right"></i>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> 
            Manage database configuration overrides. These values take precedence over appsettings.json.
        </div>

        <div class="mb-3 row">
            <div class="col-md-4">
                <button class="btn btn-success" @onclick="ShowAddModal">
                    <i class="bi bi-plus-circle"></i> Add Override
                </button>
                <button class="btn btn-warning" @onclick="ReloadConfiguration">
                    <i class="bi bi-arrow-clockwise"></i> Reload
                </button>
                <button class="btn btn-danger" @onclick="ResetToAppSettings">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset All
                </button>
            </div>
            <div class="col-md-4">
                <input type="text" 
                       class="form-control" 
                       placeholder="Search overrides..." 
                       @bind="databaseSearchFilter"
                       @bind:event="oninput"
                       @bind:after="ResetDatabasePage" />
            </div>
            <div class="col-md-4">
                <select class="form-select" @bind="databasePageSize" @bind:after="ResetDatabasePage">
                    <option value="10">10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
            </div>
        </div>

        @if (configurations == null)
        {
            <div class="d-flex justify-content-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (!GetFilteredDatabaseConfigurations().Any())
        {
            <div class="alert alert-info">
                @if (string.IsNullOrWhiteSpace(databaseSearchFilter))
                {
                    <text>No database overrides configured. All values are loaded from appsettings.json.</text>
                }
                else
                {
                    <text>No database overrides match your search.</text>
                }
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Override Value</th>
                            <th>Last Modified</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var config in GetPagedDatabaseConfigurations())
                        {
                            <tr>
                                <td><code>@config.Key</code></td>
                                <td>
                                    @if (IsSensitiveKey(config.Key))
                                    {
                                        <span class="text-muted">
                                            <i class="bi bi-lock-fill"></i> ••••••••
                                        </span>
                                    }
                                    else
                                    {
                                        @config.Value
                                    }
                                </td>
                                <td>@config.LastModified.ToLocalTime().ToString("g")</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" @onclick="() => ShowEditModal(config)">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteConfiguration(config)">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <p class="text-muted mb-0">
                        <i class="bi bi-info-circle"></i> 
                        Showing @GetPagedDatabaseConfigurations().Count() of @GetFilteredDatabaseConfigurations().Count 
                        (@configurations.Count total)
                    </p>
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(databaseCurrentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="DatabasePreviousPage" disabled="@(databaseCurrentPage == 1)">
                                <i class="bi bi-chevron-left"></i> Previous
                            </button>
                        </li>
                        @for (int i = GetDatabaseStartPage(); i <= GetDatabaseEndPage(); i++)
                        {
                            var pageNum = i;
                            <li class="page-item @(databaseCurrentPage == pageNum ? "active" : "")">
                                <button class="page-link" @onclick="() => GoToDatabasePage(pageNum)">@pageNum</button>
                            </li>
                        }
                        <li class="page-item @(databaseCurrentPage == GetDatabaseTotalPages() ? "disabled" : "")">
                            <button class="page-link" @onclick="DatabaseNextPage" disabled="@(databaseCurrentPage == GetDatabaseTotalPages())">
                                Next <i class="bi bi-chevron-right"></i>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    }

    @if (showModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(isEdit ? "Edit" : "Add") Configuration Override</h5>
                        <button type="button" class="btn-close" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Key</label>
                            <input type="text" class="form-control" @bind="currentKey" disabled="@isEdit" />
                            @if (!isEdit)
                            {
                                <div class="form-text">
                                    Use colon (:) for nested keys. Examples:
                                    <br/>• Keycloak:Authority
                                    <br/>• AuthenticationMode
                                    <br/>• Saml2:EntityId
                                </div>
                            }
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Value</label>
                            <input type="text" class="form-control" @bind="currentValue" />
                            <div class="form-text">This will override the value in appsettings.json</div>
                        </div>
                        @if (!isEdit && !string.IsNullOrEmpty(currentKey))
                        {
                            <div class="mb-3">
                                <label class="form-label">Current Active Value</label>
                                <input type="text" class="form-control" value="@Configuration[currentKey]" disabled />
                                <div class="form-text">This is the current value from appsettings.json</div>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="SaveConfiguration">Save Override</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ConfigurationEntry>? configurations;
    private List<ActiveConfigurationItem> activeConfigurations = new();
    private bool showModal = false;
    private bool isEdit = false;
    private string currentKey = string.Empty;
    private string? currentValue;
    private string activeTab = "active";
    
    // Active Configuration pagination
    private string searchFilter = string.Empty;
    private int activeCurrentPage = 1;
    private int activePageSize = 25;
    
    // Database Overrides pagination
    private string databaseSearchFilter = string.Empty;
    private int databaseCurrentPage = 1;
    private int databasePageSize = 25;

    private class ActiveConfigurationItem
    {
        public string Key { get; set; } = string.Empty;
        public string? Value { get; set; }
        public bool IsInDatabase { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadConfigurations();
        LoadActiveConfiguration();
    }

    private void ShowActiveTab()
    {
        activeTab = "active";
    }

    private void ShowDatabaseTab()
    {
        activeTab = "database";
    }

    private void LoadActiveConfiguration()
    {
        var dbKeys = configurations?.Select(c => c.Key).ToHashSet() ?? new HashSet<string>();
        activeConfigurations = new List<ActiveConfigurationItem>();

        // Get ALL configuration values by enumerating the configuration root
        if (Configuration is IConfigurationRoot configRoot)
        {
            var allKeys = new HashSet<string>();
            
            // Recursively get all configuration keys
            void GetAllKeys(IConfiguration config, string prefix = "")
            {
                foreach (var child in config.GetChildren())
                {
                    var key = string.IsNullOrEmpty(prefix) ? child.Key : $"{prefix}:{child.Key}";
                    
                    // If this child has children, recurse
                    if (child.GetChildren().Any())
                    {
                        GetAllKeys(child, key);
                    }
                    else
                    {
                        // Leaf node - add to our list
                        allKeys.Add(key);
                    }
                }
            }

            GetAllKeys(Configuration);

            // Create configuration items for all keys
            foreach (var key in allKeys.OrderBy(k => k))
            {
                var value = Configuration[key];
                if (!string.IsNullOrEmpty(value))
                {
                    activeConfigurations.Add(new ActiveConfigurationItem
                    {
                        Key = key,
                        Value = value,
                        IsInDatabase = dbKeys.Contains(key)
                    });
                }
            }
        }
    }

    // Active Configuration filtering and pagination
    private List<ActiveConfigurationItem> GetFilteredActiveConfigurations()
    {
        if (string.IsNullOrWhiteSpace(searchFilter))
            return activeConfigurations;

        return activeConfigurations
            .Where(c => c.Key.Contains(searchFilter, StringComparison.OrdinalIgnoreCase) ||
                       (c.Value?.Contains(searchFilter, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();
    }

    private IEnumerable<ActiveConfigurationItem> GetPagedActiveConfigurations()
    {
        var filtered = GetFilteredActiveConfigurations();
        return filtered
            .Skip((activeCurrentPage - 1) * activePageSize)
            .Take(activePageSize);
    }

    private int GetActiveTotalPages()
    {
        var filtered = GetFilteredActiveConfigurations();
        return (int)Math.Ceiling(filtered.Count / (double)activePageSize);
    }

    private int GetActiveStartPage()
    {
        var totalPages = GetActiveTotalPages();
        if (totalPages <= 7) return 1;
        
        var start = activeCurrentPage - 3;
        return Math.Max(1, Math.Min(start, totalPages - 6));
    }

    private int GetActiveEndPage()
    {
        var totalPages = GetActiveTotalPages();
        if (totalPages <= 7) return totalPages;
        
        var end = activeCurrentPage + 3;
        return Math.Min(totalPages, Math.Max(7, end));
    }

    private void ActivePreviousPage()
    {
        if (activeCurrentPage > 1)
            activeCurrentPage--;
    }

    private void ActiveNextPage()
    {
        if (activeCurrentPage < GetActiveTotalPages())
            activeCurrentPage++;
    }

    private void GoToActivePage(int page)
    {
        activeCurrentPage = page;
    }

    private void ResetActivePage()
    {
        activeCurrentPage = 1;
    }

    // Database Configuration filtering and pagination
    private List<ConfigurationEntry> GetFilteredDatabaseConfigurations()
    {
        if (configurations == null)
            return new List<ConfigurationEntry>();

        if (string.IsNullOrWhiteSpace(databaseSearchFilter))
            return configurations;

        return configurations
            .Where(c => c.Key.Contains(databaseSearchFilter, StringComparison.OrdinalIgnoreCase) ||
                       (c.Value?.Contains(databaseSearchFilter, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();
    }

    private IEnumerable<ConfigurationEntry> GetPagedDatabaseConfigurations()
    {
        var filtered = GetFilteredDatabaseConfigurations();
        return filtered
            .Skip((databaseCurrentPage - 1) * databasePageSize)
            .Take(databasePageSize);
    }

    private int GetDatabaseTotalPages()
    {
        var filtered = GetFilteredDatabaseConfigurations();
        return (int)Math.Ceiling(filtered.Count / (double)databasePageSize);
    }

    private int GetDatabaseStartPage()
    {
        var totalPages = GetDatabaseTotalPages();
        if (totalPages <= 7) return 1;
        
        var start = databaseCurrentPage - 3;
        return Math.Max(1, Math.Min(start, totalPages - 6));
    }

    private int GetDatabaseEndPage()
    {
        var totalPages = GetDatabaseTotalPages();
        if (totalPages <= 7) return totalPages;
        
        var end = databaseCurrentPage + 3;
        return Math.Min(totalPages, Math.Max(7, end));
    }

    private void DatabasePreviousPage()
    {
        if (databaseCurrentPage > 1)
            databaseCurrentPage--;
    }

    private void DatabaseNextPage()
    {
        if (databaseCurrentPage < GetDatabaseTotalPages())
            databaseCurrentPage++;
    }

    private void GoToDatabasePage(int page)
    {
        databaseCurrentPage = page;
    }

    private void ResetDatabasePage()
    {
        databaseCurrentPage = 1;
    }

    private bool IsSensitiveKey(string key)
    {
        var sensitiveKeywords = new[] { "secret", "password", "connectionstring", "key", "token" };
        return sensitiveKeywords.Any(keyword => key.Contains(keyword, StringComparison.OrdinalIgnoreCase));
    }

    private async Task LoadConfigurations()
    {
        configurations = await ConfigService.GetAllAsync();
        LoadActiveConfiguration();
    }

    private void ShowAddModal()
    {
        isEdit = false;
        currentKey = string.Empty;
        currentValue = null;
        showModal = true;
    }

    private void ShowEditModal(ConfigurationEntry config)
    {
        isEdit = true;
        currentKey = config.Key;
        currentValue = config.Value;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private async Task SaveConfiguration()
    {
        if (string.IsNullOrWhiteSpace(currentKey))
            return;

        await ConfigService.AddOrUpdateAsync(currentKey, currentValue);
        await LoadConfigurations();
        CloseModal();
    }

    private async Task DeleteConfiguration(ConfigurationEntry config)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Delete configuration override for '{config.Key}'? The value will revert to appsettings.json.");
        if (confirmed)
        {
            await ConfigService.DeleteAsync(config.Key);
            await LoadConfigurations();
        }
    }

    private async Task ReloadConfiguration()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "Reload configuration from database? This will apply any changes without restarting the application.");
        if (confirmed)
        {
            await ConfigService.ReloadConfigurationAsync();
            await LoadConfigurations();
        }
    }

    private async Task ResetToAppSettings()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "This will delete ALL database configuration overrides and reload from appsettings.json. Continue?");
        if (confirmed)
        {
            await ConfigService.ResetFromAppSettingsAsync();
            await LoadConfigurations();
        }
    }
}